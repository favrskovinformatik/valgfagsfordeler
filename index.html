<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Valgfagsfordeling</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background: #f4f7f6; }
        .container { max-width: 1400px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; margin-bottom: 40px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; vertical-align: top; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 10; }
        .fag-matrix th { background: #2c3e50; color: white; }
        .card { background: #eef2f3; padding: 15px; border-radius: 5px; border-left: 5px solid #27ae60; margin: 20px 0; }
        .missing-cell { background-color: #ffdce0; color: #b71c1c; white-space: normal !important; min-width: 250px; }
        .student-error { background-color: #fff5f5; }
        .diag-text { display: block; font-size: 10px; font-weight: normal; color: #666; font-style: italic; margin-top: 2px; line-height: 1.4; }
        pre { background: #1a1a1a; color: #00ff00; padding: 10px; border-radius: 5px; font-size: 11px; max-height: 150px; overflow: auto; margin: 10px 0; }
        .slider-box { margin: 15px 0; padding: 10px; background: #eee; border-radius: 4px; }
        .split-box { background: #fff3cd; padding: 15px; border-radius: 5px; border-left: 5px solid #ffc107; margin-bottom: 10px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: #2c3e50; margin-top: 30px; }
        input[type="text"] { width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Valgfagsfordeling</h1>
    
    <div class="split-box">
        <strong>Strategisk Hold-Split:</strong><br>
        Indtast fag (f.eks. <code>fiC, idB</code>), der skal have et ekstra hold:<br>
        <input type="text" id="splitFag" placeholder="f.eks. fiC, idB">
    </div>

    <div class="split-box" style="border-left-color: #3498db;">
        <strong>Eksklusive Fag (Unikke Bånd):</strong><br>
        Hold med denne fagkode må ikke ligge i samme bånd som andre hold med samme fagkode (f.eks. <code>ia, id</code>):<br>
        <input type="text" id="exclusiveFag" placeholder="f.eks. ia, id">
    </div>

<section>
  <p>
    <strong>Kolonner:</strong> Filen <strong>SKAL</strong> indeholde kolonnerne <strong>Id</strong>, <strong>Navn</strong>, <strong>Vf1</strong>, <strong>Vf2</strong>, <strong>Vf3</strong> og <strong>Fr.sprog</strong>.
  </p>
  
  <p><strong>Eksempel på dataformat i Excel:</strong></p>
  <table border="1" style="border-collapse: collapse; width: 100%; text-align: left;">
    <thead>
      <tr style="background-color: #f2f2f2;">
        <th>Id</th>
        <th>Navn</th>
        <th>Vf1</th>
        <th>Vf2</th>
        <th>Vf3</th>
        <th>Fr.sprog</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>2p 23</td>
        <td>Jensen, Mette</td>
        <td>&lt;enA&gt;</td>
        <td>&lt;tyFort.A&gt;</td>
        <td>&lt;inC&gt;</td>
        <td></td>
      </tr>
      <tr>
        <td>2q 08</td>
        <td>Petersen, Jonas</td>
        <td>&lt;iaB&gt;</td>
        <td>&lt;tyFort.B&gt;</td>
        <td></td>
        <td>24spA2</td>
      </tr>
    </tbody>
  </table>
  
  <p>
    <em>Bemærk: Valgfag står typisk i vinkelparenteser &lt;&gt;, mens fremmedsprog ofte står som ren tekst. Tomme celler er helt okay.</em>
  </p>
</section>
    <div class="slider-box">
        <label for="simRange">Antal simuleringer: <b id="simVal">50000</b></label><br>
        <input type="range" id="simRange" min="10000" max="10000000" step="10000" value="50000" oninput="document.getElementById('simVal').innerText = this.value" style="width: 100%;">
    </div>
    <input type="file" id="excelFile" />
    <button onclick="process()">Kør Optimering</button>
<button id="downloadBtn" onclick="downloadExcel()" style="display:none; background:#27ae60; color:white;">Download Excel</button>
    
    <div id="summary" style="display:none;">
        <div class="card" id="statusBox"></div>
    </div>
    
    <pre id="log">Klar...</pre>
    <div id="result"></div>
</div>

<script>
function escapeHTML(s) { 
    return s ? s.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : ""; 
}

function assignStudentsStrict(students, holds, capacity) {
    holds.forEach(h => h.students = []);
    let totalMangler = 0;
    students.forEach(s => {
        let optionsPerWish = s.wishes.map(w => holds.filter(h => h.fag === w));
        let bestSet = [];
        function backtrack(wishIdx, currentSet, usedBands) {
            if (wishIdx === s.wishes.length) {
                if (currentSet.length > bestSet.length) bestSet = [...currentSet];
                return;
            }
            backtrack(wishIdx + 1, currentSet, usedBands);
            let possibleHolds = optionsPerWish[wishIdx]
                .filter(h => h.students.length < capacity && !usedBands.has(h.band))
                .sort((a, b) => a.students.length - b.students.length);
            for (let h of possibleHolds) {
                currentSet.push(h);
                usedBands.add(h.band);
                backtrack(wishIdx + 1, currentSet, usedBands);
                if (bestSet.length === s.wishes.length) return;
                usedBands.delete(h.band);
                currentSet.pop();
            }
        }
        backtrack(0, [], new Set());
        bestSet.forEach(h => h.students.push(s.id));
        totalMangler += (s.wishes.length - bestSet.length);
    });
    return totalMangler;
}

async function process() {
    const file = document.getElementById('excelFile').files[0];
    const iterations = parseInt(document.getElementById('simRange').value);
    
    const splitInput = document.getElementById('splitFag').value
        .split(',')
        .map(s => s.trim().replace(/[<>]/g, "").toLowerCase())
        .filter(s => s !== "");

    const exclusiveInput = document.getElementById('exclusiveFag').value
        .split(',')
        .map(s => s.trim().toLowerCase())
        .filter(s => s !== "");

    if (!file) return alert("Vælg fil");
    
    const logBox = document.getElementById('log');
    logBox.innerText = `Initialiserer v4.5.3...\n`;

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, {header:1});

    const head = rows[0].map(h => String(h||"").trim().toLowerCase());
    const idx = { id: head.indexOf('id'), navn: head.indexOf('navn'), v1: head.indexOf('vf1'), v2: head.indexOf('vf2'), v3: head.indexOf('vf3'), sp: head.indexOf('fr.sprog') };

    const students = rows.slice(1).map(r => ({
        id: String(r[idx.id]||""),
        navn: String(r[idx.navn]||""),
        wishes: [r[idx.sp], r[idx.v1], r[idx.v2], r[idx.v3]].map(v => String(v||"").trim()).filter(v => v !== "")
    })).filter(s => s.id);

    let counts = {};
    students.forEach(s => s.wishes.forEach(w => counts[w] = (counts[w]||0) + 1));
    
    students.forEach(s => {
        s.difficulty = s.wishes.reduce((acc, w) => acc + (counts[w] || 0), 0);
    });

    let baseHolds = [];
    for (let code in counts) {
        let num = Math.ceil(counts[code] / 30);
        let cleanCode = code.replace(/[<>]/g, "").toLowerCase();
        
        if (splitInput.includes(cleanCode)) {
            num += 1;
            logBox.innerText += `BEKRÆFTET SPLIT: ${code} (Nu ${num} hold)\n`;
        }

        for (let i=0; i<num; i++) {
            baseHolds.push({ id: Math.random(), name: num > 1 ? `${code} (H${i+1})` : code, fag: code });
        }
    }

    let bestMangler = 9999;
    let bestBands = [];
    let bestOrder = [];

    logBox.innerText += `Starter ${iterations} simuleringer...\n`;

    for (let r=0; r < iterations; r++) {
        let currentHolds = baseHolds.map(h => ({...h, band: 0, students: []}));
        let fagOccupiedInBands = {};
        let exclusiveOccupied = {};
        exclusiveInput.forEach(key => exclusiveOccupied[key] = new Set());

        currentHolds.filter(h => h.band === 0).forEach(h => {
            const f = h.fag.toLowerCase();
            const isC = f.includes('c>') || f.includes('c ') || f.endsWith('c');
            let pb = isC ? [1, 2, 3, 4] : [1, 2, 3];

            // Eksklusiv bånd-tjek
            let activeExclusives = exclusiveInput.filter(key => f.includes(key));
            activeExclusives.forEach(key => {
                pb = pb.filter(b => !exclusiveOccupied[key].has(b));
            });

            if (fagOccupiedInBands[h.fag]) {
                pb = pb.filter(b => !fagOccupiedInBands[h.fag].has(b));
                pb = pb.filter(b => b !== 1);
            }

            let b = pb.length > 0 ? pb[Math.floor(Math.random() * pb.length)] : (isC ? Math.floor(Math.random()*4)+1 : Math.floor(Math.random()*3)+1);
            
            h.band = b;
            activeExclusives.forEach(key => exclusiveOccupied[key].add(b));

            if (!fagOccupiedInBands[h.fag]) fagOccupiedInBands[h.fag] = new Set();
            fagOccupiedInBands[h.fag].add(b);
        });

        let currentOrder = [...students].sort((a, b) => (a.difficulty - b.difficulty) || (Math.random() - 0.5));
        let currentMangler = assignStudentsStrict(currentOrder, currentHolds, 30);

        if (currentMangler < bestMangler) {
            bestMangler = currentMangler;
            bestBands = currentHolds.map(h => h.band);
            bestOrder = currentOrder.map(s => s.id);
            logBox.innerText += `Runde ${r}: Rekord! ${bestMangler} mangler\n`;
            logBox.scrollTop = logBox.scrollHeight;
            if (bestMangler === 0) break;
        }
        if (r % 10000 === 0) await new Promise(res => setTimeout(res, 0));
    }

    let finalHolds = baseHolds.map((h, i) => ({...h, band: bestBands[i], students: []}));
    let finalOrder = bestOrder.map(id => students.find(s => s.id === id));
    assignStudentsStrict(finalOrder, finalHolds, 30);

    let fagListe = [...new Set(finalHolds.map(h => h.fag))].sort();
    let matrixHtml = "<h2>Fagoversigt (Holdplacering)</h2><table class='fag-matrix'><thead><tr><th>Fag</th><th>Bånd 1</th><th>Bånd 2</th><th>Bånd 3</th><th>Bånd 4</th></tr></thead><tbody>";
    fagListe.forEach(f => {
        matrixHtml += `<tr><td><strong>${escapeHTML(f)}</strong></td>`;
        for (let b = 1; b <= 4; b++) {
            let hInB = finalHolds.filter(h => h.fag === f && h.band === b).map(h => `${h.name} (${h.students.length})`);
            matrixHtml += `<td>${escapeHTML(hInB.join(", "))}</td>`;
        }
        matrixHtml += "</tr>";
    });
    matrixHtml += "</tbody></table>";

    let reportData = students.map(s => {
        let res = { id: s.id, navn: s.navn, b1:"", b2:"", b3:"", b4:"", none: [], hasError: false };
        let gotFag = new Set(), occupiedBands = {};
        finalHolds.forEach(h => { if (h.students.includes(s.id)) { res["b"+h.band] = h.name; gotFag.add(h.fag); occupiedBands[h.band] = h.name; } });
        s.wishes.forEach(w => {
            if (!gotFag.has(w)) {
                let diags = finalHolds.filter(h => h.fag === w).map(h => {
                    let reason = h.students.length >= 30 ? `Fyldt (${h.students.length}/30)` : `Konflikt m. ${occupiedBands[h.band] || 'andet fag'}`;
                    return `Bånd ${h.band}: ${reason}`;
                });
                res.none.push({ fag: w, diag: diags });
                res.hasError = true;
            }
        });
        return res;
    });

    reportData.sort((a,b) => (b.hasError - a.hasError) || a.navn.localeCompare(b.navn));

    let studentHtml = "<h2>Elevoversigt</h2><table id='studentTable'><thead><tr><th>ID</th><th>Navn</th><th>B1</th><th>B2</th><th>B3</th><th>B4</th><th>Ikke placeret (Årsag)</th></tr></thead><tbody>";
    reportData.forEach(r => {
        let noneHtml = r.none.map(m => `<div><b>${escapeHTML(m.fag)}</b>${m.diag.map(d => `<span class="diag-text">${escapeHTML(d)}</span>`).join("")}</div>`).join("");
        studentHtml += `<tr class="${r.hasError ? 'student-error' : ''}"><td>${escapeHTML(r.id)}</td><td>${escapeHTML(r.navn)}</td><td>${escapeHTML(r.b1)}</td><td>${escapeHTML(r.b2)}</td><td>${escapeHTML(r.b3)}</td><td>${escapeHTML(r.b4)}</td><td class="${r.none.length > 0 ? 'missing-cell' : ''}">${noneHtml}</td></tr>`;
    });
    studentHtml += "</tbody></table>";

    document.getElementById('result').innerHTML = matrixHtml + studentHtml;
    document.getElementById('summary').style.display = 'block';
    let totalManglerCount = reportData.reduce((acc, r) => acc + r.none.length, 0);
    document.getElementById('statusBox').innerHTML = `<strong>STATUS:</strong> ${totalManglerCount} mangler.`;
    document.getElementById('downloadBtn').style.display = 'inline-block';
}

function downloadExcel() {
    try {
        const wb = XLSX.utils.book_new();
        const matrixTable = document.querySelector('.fag-matrix');
        if (matrixTable) {
            const ws1 = XLSX.utils.table_to_sheet(matrixTable);
            XLSX.utils.book_append_sheet(wb, ws1, "Fagoversigt");
        }
        const studentTable = document.getElementById('studentTable');
        if (studentTable) {
            const ws2 = XLSX.utils.table_to_sheet(studentTable);
            XLSX.utils.book_append_sheet(wb, ws2, "Elevoversigt");
        } else {
            alert("Kunne ikke finde elevoversigten. Kør optimeringen først.");
            return;
        }
        const d = new Date();
        const timeStr = d.getHours() + "-" + d.getMinutes();
        XLSX.writeFile(wb, `Valgfagsfordeling_${timeStr}.xlsx`);
    } catch (e) {
        console.error("Fejl ved download:", e);
        alert("Fejl: " + e.message);
    }
}
</script>
</body>
</html>
